<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>後台產品管理</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
    <style>
        .star {
            color: gold;
            font-size: 1.2rem;
        }
    </style>
</head>
<body>
<div class="container mt-4">
    <h2>後台產品管理</h2>

    <!-- 新增產品按鈕 -->
    <button type="button" class="btn btn-warning mb-3" data-bs-toggle="modal" data-bs-target="#productModal" onclick="openCreateModal()">
        新增產品
    </button>

    <table id="productTable" class="table table-hover">
        <thead>
        <tr>
            <th>ID</th>
            <th>名稱</th>
            <th>價格</th>
            <th>分類</th>
            <th>庫存</th>
            <th>評價</th>
            <th>狀態</th>
            <th>操作</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="product : ${products}"
            th:data-des="${product.productDes}"
            th:data-photo="${product.productPhoto}"
            th:data-star="${product.totalStar}"
            th:data-review="${product.totalReview}"
            th:data-rating="${product.averageRating}">
            <td th:text="${product.productId}"></td>
            <td th:text="${product.productName}"></td>
            <td th:text="${product.productPrice}"></td>
            <td th:text="${product.categoryName}"></td>
            <td th:text="${product.productStock}"></td>
            <td>
                 <div th:if="${product.averageRating != null}">
    <!-- 滿星 -->
    <span th:each="i : ${#numbers.sequence(1, T(java.lang.Math).floor(product.averageRating))}" class="star">★</span>

    <!-- 半星 -->
    <span th:if="${product.averageRating - T(java.lang.Math).floor(product.averageRating) >= 0.25 and product.averageRating - T(java.lang.Math).floor(product.averageRating) < 0.75}" class="star">⯨</span>

    <!-- 空星 -->
    <span th:each="i : ${#numbers.sequence(1, 5 - T(java.lang.Math).floor(product.averageRating) - (product.averageRating - T(java.lang.Math).floor(product.averageRating) >= 0.25 and product.averageRating - T(java.lang.Math).floor(product.averageRating) < 0.75 ? 1 : 0))}" class="star text-secondary">☆</span>

    <!-- 顯示數值 -->
    <span th:text="${product.averageRating}" class="text-muted small ms-2"></span>
  </div>
  <div th:if=\"${product.averageRating == null}\" class=\"text-muted small\">尚無評價</div>
            </td>
            <td th:text="${product.isDeletedStatus} ? '已刪除' : '啟用中'"></td>
            <td>
                <button class="btn btn-outline-primary btn-sm edit-btn" data-bs-toggle="modal" data-bs-target="#productModal"
                        th:data-id="${product.productId}" onclick="openEditModal(this)">編輯</button>
                <button th:if="${!product.isDeletedStatus}" class="btn btn-outline-danger btn-sm delete-btn"
                        th:data-id="${product.productId}">刪除</button>
                <button th:if="${product.isDeletedStatus}" class="btn btn-outline-success btn-sm restore-btn"
                        th:data-id="${product.productId}">復原</button>
            </td>
        </tr>
        </tbody>
    </table>
</div>

<!-- 產品新增/編輯 Modal -->
<div class="modal fade" id="productModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="productModalLabel">新增 / 編輯產品</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="productForm">
                    <input type="hidden" id="productId">
                    <div class="mb-3">
                        <label for="productName" class="form-label">產品名稱</label>
                        <input type="text" class="form-control" id="productName" required>
                    </div>
                    <div class="mb-3">
                        <label for="productPrice" class="form-label">價格</label>
                        <input type="number" class="form-control" id="productPrice" required>
                    </div>
                    <div class="mb-3">
                        <label for="categoryName" class="form-label">分類</label>
                        <input type="text" class="form-control" id="categoryName" required>
                    </div>
                    <div class="mb-3">
                        <label for="productStock" class="form-label">庫存</label>
                        <input type="number" class="form-control" id="productStock" required>
                    </div>
                    <div class="mb-3">
                        <label for="productDes" class="form-label">產品描述</label>
                        <textarea class="form-control" id="productDes" rows="2"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="productPhoto" class="form-label">產品圖片 URL</label>
                        <input type="text" class="form-control" id="productPhoto" oninput="previewPhoto()">
                        <img id="photoPreview" src="" class="img-thumbnail mt-2" style="max-height: 150px; display: none;">
                    </div>
                    <button type="submit" class="btn btn-outline-success">送出</button>
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">取消</button>
                </form>
            </div>
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    $(document).ready(function () {
        $('#productTable').DataTable();

        $('.delete-btn').on('click', function () {
            const id = $(this).data('id');
            if (confirm('確定要刪除這筆產品嗎？')) {
                $.ajax({ url: `/product/delete?id=${id}`, type: 'DELETE', success: () => location.reload(), error: () => alert('刪除失敗') });
            }
        });

        $('.restore-btn').on('click', function () {
            const id = $(this).data('id');
            if (confirm('確定要復原這筆產品嗎？')) {
                $.ajax({ url: `/product/restore?id=${id}`, type: 'PUT', success: () => location.reload(), error: () => alert('復原失敗') });
            }
        });

        $('#productForm').on('submit', function (e) {
            e.preventDefault();
            const product = {
                productId: $('#productId').val(),
                productName: $('#productName').val(),
                productPrice: $('#productPrice').val(),
                categoryName: $('#categoryName').val(),
                productStock: $('#productStock').val(),
                productDes: $('#productDes').val(),
                productPhoto: $('#productPhoto').val()
            };
            const method = product.productId ? 'PUT' : 'POST';
            const url = product.productId ? `/product/update?id=${product.productId}` : '/product/create';

            $.ajax({
                url: url,
                type: method,
                contentType: 'application/json',
                data: JSON.stringify(product),
                success: () => location.reload(),
                error: () => alert('儲存失敗')
            });
        });
    });

    function openCreateModal() {
        $('#productModalLabel').text('新增產品');
        $('#productForm')[0].reset();
        $('#productId').val('');
        $('#photoPreview').hide();
    }

    function openEditModal(button) {
        $('#productModalLabel').text('編輯產品');
        const row = $(button).closest('tr');
        $('#productId').val($(button).data('id'));
        $('#productName').val(row.find('td:eq(1)').text());
        $('#productPrice').val(row.find('td:eq(2)').text());
        $('#categoryName').val(row.find('td:eq(3)').text());
        $('#productStock').val(row.find('td:eq(4)').text());
        $('#productDes').val(row.data('des'));
        $('#productPhoto').val(row.data('photo'));
        if (row.data('photo')) {
            $('#photoPreview').attr('src', row.data('photo')).show();
        } else {
            $('#photoPreview').hide();
        }
    }

    function previewPhoto() {
        const url = $('#productPhoto').val();
        if (url) {
            $('#photoPreview').attr('src', url).show();
        } else {
            $('#photoPreview').hide();
        }
    }
</script>
</body>
</html>
